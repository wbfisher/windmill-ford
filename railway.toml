# Railway Configuration for SMSI Fleet Dashboard

version: "1.0"

services:
  windmill:
    image: ghcr.io/windmill-labs/windmill:latest
    environment:
      DATABASE_URL: ${{windmill-db.DATABASE_URL}}
      FLEET_DATABASE_URL: ${{fleet-db.DATABASE_URL}}
      MODE: standalone
      WM_BASE_URL: https://${{RAILWAY_PUBLIC_DOMAIN}}
      DISABLE_SECURE_COOKIES: false
    healthcheck:
      path: /api/version
      interval: 30s
    domains:
      - ${{RAILWAY_PUBLIC_DOMAIN}}

  windmill-db:
    image: postgres:15
    environment:
      POSTGRES_DB: windmill
      POSTGRES_USER: windmill
      POSTGRES_PASSWORD: ${{POSTGRES_PASSWORD}}
    volumes:
      - windmill_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "windmill"]
      interval: 10s

  fleet-db:
    image: timescale/timescaledb:latest-pg15
    environment:
      POSTGRES_DB: fleet_metrics
      POSTGRES_USER: smsi_fleet
      POSTGRES_PASSWORD: ${{FLEET_DB_PASSWORD}}
    volumes:
      - fleet_data:/var/lib/postgresql/data
      - ./database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "smsi_fleet"]
      interval: 10s

volumes:
  windmill_data:
  fleet_data:

# Environment variables to set in Railway:
# POSTGRES_PASSWORD - Windmill database password
# FLEET_DB_PASSWORD - Fleet metrics database password
# RAILWAY_PUBLIC_DOMAIN - Auto-provided by Railway
