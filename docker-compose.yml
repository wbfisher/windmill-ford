# Docker Compose for SMSI Fleet Dashboard
# Works for both local development and Railway deployment

version: '3.8'

services:
  windmill:
    image: ghcr.io/windmill-labs/windmill:latest
    ports:
      - "${PORT:-8000}:8000"
    environment:
      DATABASE_URL: postgresql://windmill:${WINDMILL_DB_PASSWORD:-windmill}@windmill-db/windmill?sslmode=disable
      MODE: standalone
      WM_BASE_URL: ${WM_BASE_URL:-http://localhost:8000}
      FLEET_DATABASE_URL: postgresql://smsi:${FLEET_DB_PASSWORD:-fleet123}@fleet-db/fleet_metrics?sslmode=disable
      DISABLE_SECURE_COOKIES: ${DISABLE_SECURE_COOKIES:-true}
      # Ford Pro API credentials
      FORD_PRO_CLIENT_ID: ${FORD_PRO_CLIENT_ID}
      FORD_PRO_CLIENT_SECRET: ${FORD_PRO_CLIENT_SECRET}
      FORD_PRO_FLEET_ID: ${FORD_PRO_FLEET_ID}
    depends_on:
      windmill-db:
        condition: service_healthy
      fleet-db:
        condition: service_healthy
    volumes:
      - ./windmill:/usr/src/app
    restart: unless-stopped

  windmill-db:
    image: postgres:15
    environment:
      POSTGRES_USER: windmill
      POSTGRES_PASSWORD: ${WINDMILL_DB_PASSWORD:-windmill}
      POSTGRES_DB: windmill
    ports:
      - "${WINDMILL_DB_PORT:-5432}:5432"
    volumes:
      - windmill_db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U windmill"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  fleet-db:
    image: timescale/timescaledb:latest-pg15
    environment:
      POSTGRES_USER: smsi
      POSTGRES_PASSWORD: ${FLEET_DB_PASSWORD:-fleet123}
      POSTGRES_DB: fleet_metrics
    ports:
      - "${FLEET_DB_PORT:-5433}:5432"
    volumes:
      - fleet_db:/var/lib/postgresql/data
      - ./database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U smsi"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

volumes:
  windmill_db:
  fleet_db:

networks:
  default:
    name: smsi-fleet
